version: "3"



tasks:
        # meson install -C build

  build:
    dir: ..
    deps:
      - build-setup
    cmds:
      - |
        cd {{.TASKFILE_DIR}}
        ninja -C build
        meson install -C build --no-rebuild
    silent: true
    env:
      PKG_CONFIG_PATH: '{{.ROOT_DIR}}/{{.chafa_PKG_CONFIG_PATH}}'
  clean:
    dir: ..
    deps:
      - clean-setup
      - clean-chafa
    cmds:
      - rm -rf {{.ROOT_DIR}}/{{.libinterop_OUT_DIR}}


  build-chafa:
    internal: true
    silent: true
    cmds:
      - |
        cd {{.ROOT_DIR}}/third_party/chafa_source
        mkdir -p build
        cd build
        ../autogen.sh --prefix={{.ROOT_DIR}}/{{.chafa_OUT_DIR}}
        make -j$(nproc)
        make install
    status:
      - test -d {{.ROOT_DIR}}/{{.chafa_LIB_DIR}}

  clean-chafa:
    cmds:
      - | 
          cd {{.ROOT_DIR}}/third_party/chafa_source
          make distclean || true
      - rm -rf {{.ROOT_DIR}}/{{.chafa_OUT_DIR}}
      - rm -rf {{.ROOT_DIR}}/third_party/chafa_source/build
      



  build-setup:
    deps:
      - build-chafa
    internal: true
    silent: true
    cmds:
      - |
        cd {{.TASKFILE_DIR}}
        echo "Package config path is {{.PKG_CONFIG_PATH}}   {{.chafa_PKG_CONFIG_PATH}}"
        meson setup build --prefix={{.ROOT_DIR}}/{{.libinterop_OUT_DIR}}
    env:
      PKG_CONFIG_PATH: '{{.ROOT_DIR}}/{{.chafa_PKG_CONFIG_PATH}}'
    status:
      - test -d {{.TASKFILE_DIR}}/build
  
  clean-setup:
    deps:
      - clean-chafa
    cmds:
      - rm -rf {{.TASKFILE_DIR}}/build

  # check-chafa:
  #   internal: true
  #   silent: true
  #   cmds:
  #     - |
  #       echo "Chafa is not installed."
  #       echo "On ubuntu try: "
  #       echo "sudo apt install libchafa-dev"
  #       echo "On other systems, check your package manager for the dependency."
  #       false
  #   status:
  #     -  pkg-config --cflags chafa


vars:
  libinterop_OUT_DIR: deps/libinterop
